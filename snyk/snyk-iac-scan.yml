parameters:
  - name: organization
    displayName: Organization ID in Snyk
    type: string
  - name: serviceConnectionToken
    displayName: Snyk Service Account Token
    type: string
  - name: targetFile
    displayName: Custom path to manifest file to test
    type: string
  - name: severityThreshold
    displayName: Testing severity threshold
    type: string
  - name: additionalArguments
    displayName: Additional command-line args for Snyk CLI 
    type: string

steps:
  - script: |
      SNYK_TOKEN=${{ parameters.serviceConnectionToken }} snyk iac test ${{ parameters.targetFile }} \
      --org=${{ parameters.organization }} \
      --severity-threshold=${{ parameters.severityThreshold }} \
      --json \
      ${{ parameters.additionalArguments }} \
      | snyk-to-html -o snyk_iac_results.html
    displayName: Perform IAC Scan
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: $(System.DefaultWorkingDirectory)/snyk_iac_results.html
      artifact: snyk_iac_results.html
      publishLocation: 'pipeline'
    displayName: 'Publish artifact: CodeScanningResults'
    condition: always()