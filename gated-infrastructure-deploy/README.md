# Template for Gated Infrastructure Deploy

This template is designed to allow you to deploy terraform resources with a manually verification if any resources are getting destroyed. This manual verification will only trigger if there is indication that resources will be destroyed. If triggered, then the job will fail after a timeout has been reached. If there is no indication that resources wil be destroyed, the template will carry on and deploy the resources.

This template makes use of `terraform plan` and `terraform apply`.

**The plan cannot foresee every circumstance and scenario compared to the apply.**

## Usage

1. Reference this repository in your root `azure-pipelines.yml` file.

    ```yaml
    resources:
      repositories:
        - repository: UKHOTemplates
          type: github
          endpoint: UKHO
          name: UKHO/devops-pipelinetemplates
          ref: refs/heads/gated-infrastructure-deploy-template
    ```

2. Add this template block to your pipeline and fill out the values that relate to you deployment. The template content is a series of `jobs`, therefore they need to be rooted under a `stage`.

    ```yaml
    jobs:
      - template: gated-infrastructure-deploy/gated-infrastructure-deploy.yml@UKHOTemplates
        parameters:
          Environment: "string"
          AzDOEnvironmentName: "string"
          TFStateResourceGroupName: "string"
          TFStateStorageAccountName: "string"
          TFStateContainerName: "string"
          TFStateBlobName: "string"
          TerraformDirectory: "string"
          TerraformArtifact: "string"
          VariablesTemplateFullPath: "string"
          TerraformVariableMappings:
            TERRAFORM_VARIABLE: "VALUE" 
          TerraformOutputVariables: # optional
            POSSIBLE_TERRAFORM_OUTPUT_VARIABLE
    ```

3. Consult the table below to fill out each of the parameters with the value that you require.

   | parameter                           | Required | Type   | Description                                                                                                                                                                                                               | Example Value                                                                                                                                                                                                                                                          | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
   |-------------------------------------|----------|--------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | AzDOEnvironmentName                 | Yes      | string | The name of the AzDO Environment to deploy into, include the full name, will be used as is.                                                                                                                               | AcgConnect-Dev                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | TFStateResourceGroupName            | Yes      | string | The name of the RG that stores the SA that stores the TF State.                                                                                                                                                           | m-spokeconnect-rg                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | TFStateStorageAccountName           | Yes      | string | The name of the SA that stores the TF State.                                                                                                                                                                              | acgdevsa                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | TFStateContainerName                | Yes      | string | The name of the Container that holds the blob for TF State.                                                                                                                                                               | tfstate                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | TFStateBlobName                     | Yes      | string | The name of the blob holding the TF State/                                                                                                                                                                                | terraform.deployment.tfplan                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | TerraformWorkspace                  | Yes      | string | The terraform workspace to checkout to.                                                                                                                                                                                   | dev                                                                                                                                                                                                                                                                    | Currently, this will be appended onto the blob name as \[TFStateBlobName\]:\[TerraformWorkspace\], e.g. terraform.deployment.tfplan:dev                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
   | TerraformArtifact                   | Yes      | string | The artifact containing the terraform config files which will be deployed.                                                                                                                                                | terraformartifact                                                                                                                                                                                                                                                      | The artifact will be used as is, no modifications will be made to the contents. For all non-environment specific changes, then the build stage should complete these before the artifact is published. For all environment specific changes, then a job before this template's usage should download, edit, and republished as a new artifact the updated config files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
   | TerraformArtifactConfigRelativePath | Yes      | string | The relative path to the terraform config files inside the TerraformArtifact which will be deployed.                                                                                                                      | /                                                                                                                                                                                                                                                                      | Inside of the Template, the full path to the configuration will be $(Pipeline.Workspace)/\[Parameter *TerraformArtifact* Value\] + this parameter value. Such as "\$(Pipeline.Workspace)/terraformartifact/", the template will look for the configs in that directory.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
   | VariablesTemplateRelativePath       | Yes      | string | The relative path to a YAML Template containing a variables expression.                                                                                                                                                   | /build/pipeline/templates/var/dev-deploy.yml                                                                                                                                                                                                                           | Inside of the template, the full path to the variable template will be `${{variables['System.DefaultWorkingDirectory']}}${{ parameters.VariablesTemplateRelativePath }}@self` This allows the template to pull in all the variables it needs for the deployment. The relative path must be from the repository root directory.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
   | TerraformVariableMappings           | Yes      | object | A map consisting of terraform variables as the keys, with their values being the value to go into the terraform variables. These are injected into the PowerShell runtime environment variables for terraform to pick up. | ARM_CLIENT_ID: $(TERRAFORM-CLIENT-ID)  <br>ARM_CLIENT_SECRET: $(TERRAFORM-CLIENT-SECRET)  <br>ARM_TENANT_ID: $(TERRAFORM-TENANT-ID)  <br>ARM_SUBSCRIPTION_ID: $(TERRAFORM-SUBSCRIPTION-ID)  <br>TF_VAR_allowed_ips: $(whiteListedIps)  <br>TF_VAR_spoke_rg: $(spokeRG) | This parameter allows for the mapping of values from variable groups to what terraform configuration files will need them to be.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
   | TerraformOutputVariables            | No       | object | An array of terraform output variables to be pulled out after the terraform apply has been done.                                                                                                                          | web_app_name  <br>web_app_url                                                                                                                                                                                                                                          | Some terraform configuration have variables that are outputted for usage elsewhere, such as connection strings. This parameter allows them to be exported out via the `"##vso[task.setvariable variable=web_app_name;isoutput=true]$output"` syntax. These then can be accessed in sequential jobs by the use of a variable in a variable block: <br><br>```yaml<br>variables:  <br>- name: "WEB_APP_NAME"  <br>value: $[dependencies.deployInfrastructure.outputs['deployInfrastructure.deployment.web_app_name']]<br>```<br><br>As long as the sequential jobs have a `dependsOn` to the `deployInfrastructure` job inside of this template.<br><br>```yaml<br>- deployment: deployService  <br>displayName: "Deploy Service"  <br>dependsOn:  <br>- deployInfrastructure  <br>condition: succeeded('deployInfrastructure')  <br>variables:  <br>- name: "WEB_APP_NAME"  <br>value: $[dependencies.deployInfrastructure.outputs['deployInfrastructure.deployment.web_app_name']]<br><br>``` |

## How does it work?

The template is broken into three jobs:

- the plan job
- the manual verification
- the apply job

In the plan job, a plan is made then inspected to see if any resources are indicated for destruction. If there are, then a flag is set to true. This flag is a condition for the manual verification job, if the condition is met, then the manual verification will trigger. When the manual verification has been approved, the apply job will trigger. If approval is not given, the apply job won't run.