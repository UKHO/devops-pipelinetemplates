parameters:
- name: WorkingDirectory
  default: $(System.DefaultWorkingDirectory)
  
steps:
- checkout: self
- script: |
    mkdir ${{parameters.WorkingDirectory}}/TrivyReport
    docker run --rm -v ${{parameters.WorkingDirectory}}:/src aquasec/trivy config ./ --exit-code 1 --severity HIGH,CRITICAL
  displayName: 'Run Trivy Vulnerability Scan'
- script: |
    docker run --rm -v ${{parameters.WorkingDirectory}}:/src aquasec/trivy config ./ --format json > ${{parameters.WorkingDirectory}}/TrivyReport/Trivy-Report.json
  displayName: 'Generate Trivy JSON Report'
- task: PublishBuildArtifacts@1
  displayName: Publish Trivy JSON Report
  inputs:
    PathtoPublish: '${{parameters.WorkingDirectory}}/TrivyReport' 
    ArtifactName: 'TrivyReport'
    failTaskOnFailedTests: true
    publishRunAttachments: true
