parameters:
- name: WorkingDirectory
  default: $(System.DefaultWorkingDirectory)

steps:
- checkout: self
- script: |
    mkdir ${{parameters.WorkingDirectory}}/TrivyReport
    docker run --rm -v ${{parameters.WorkingDirectory}}:/src aquasec/trivy:latest --ignore-unfixed /src
  displayName: 'Run Trivy Vulnerability Scan'
- script: |
    docker run --rm -v ${{parameters.WorkingDirectory}}:/src aquasec/trivy:latest --ignore-unfixed --format json -o /src/TrivyReport/trivy-results.json /src
  displayName: 'Generate Trivy Report in JSON'
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '${{parameters.WorkingDirectory}}/TrivyReport'
    artifact: 'TrivyReport'
  displayName: 'Publish Trivy Report'
