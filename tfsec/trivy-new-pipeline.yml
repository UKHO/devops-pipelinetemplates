steps:
- script: echo "Starting Trivy Scan Pipeline"
  displayName: 'Initializing Trivy'

- task: DockerInstaller@0
  inputs:
    dockerVersion: '17.09.0-ce'
  displayName: 'Install Docker'

- script: |
    docker pull aquasec/trivy
  displayName: 'Pull Trivy Image'

- script: |
    echo "AVD-AZU-0047" > $(System.DefaultWorkingDirectory)/.trivyignore
  displayName: 'Create .trivyignore'

- script: |
    cat $(System.DefaultWorkingDirectory)/.trivyignore
  displayName: 'Print .trivyignore'

- script: |
    docker run --rm -v $(System.DefaultWorkingDirectory):/src aquasec/trivy config ./ --exit-code 1 --severity HIGH,CRITICAL --ignorefile .trivyignore
  displayName: 'Run Trivy Scan'

- script: |
    docker run --rm -v $(System.DefaultWorkingDirectory):/src aquasec/trivy config ./ --format json --ignorefile .trivyignore > $(System.DefaultWorkingDirectory)/TrivyReport.json
  displayName: 'Generate Trivy JSON Report'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(System.DefaultWorkingDirectory)/TrivyReport.json'
    ArtifactName: 'TrivyReport'
    publishLocation: 'Container'
  condition: succeededOrFailed()
  displayName: 'Publish Trivy JSON Report'
